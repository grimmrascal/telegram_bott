import asyncio
import logging
import random
import os
import asyncpg
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger
from pytz import timezone
from dotenv import load_dotenv

# Завантаження змінних середовища
load_dotenv()
TOKEN = os.getenv("BOT_TOKEN")
DATABASE_URL = os.getenv("DATABASE_URL")

if not TOKEN or not DATABASE_URL:
    raise ValueError("❌ Перевірте файл .env: відсутній BOT_TOKEN або DATABASE_URL.")

# Налаштування логування
logging.basicConfig(level=logging.INFO)

# Ініціалізація бота і диспетчера
bot = Bot(token=TOKEN)
dp = Dispatcher()

# Часовий пояс Києва
kyiv_tz = timezone("Europe/Kyiv")

# Підключення до бази даних
async def init_db():
    conn = await asyncpg.connect(DATABASE_URL)
    await conn.execute("""
        CREATE TABLE IF NOT EXISTS users (
            id SERIAL PRIMARY KEY,
            user_id BIGINT UNIQUE
        )
    """)
    await conn.close()

# Функція отримання користувачів із бази
async def get_users():
    conn = await asyncpg.connect(DATABASE_URL)
    rows = await conn.fetch("SELECT user_id FROM users")
    await conn.close()
    return [row["user_id"] for row in rows]

# Функція додавання користувача в базу
async def add_user(user_id):
    conn = await asyncpg.connect(DATABASE_URL)
    await conn.execute("INSERT INTO users (user_id) VALUES ($1) ON CONFLICT (user_id) DO NOTHING", user_id)
    await conn.close()

# Обробник команди /start
@dp.message(Command("start"))
async def start_handler(message: types.Message):
    user_id = message.from_user.id
    await add_user(user_id)
    await message.answer(f"Привіт, {message.from_user.first_name}! Тепер ти в списку розсилки ✅")

# Обробник команди /sendnow
@dp.message(Command("sendnow"))
async def send_now_handler(message: types.Message):
    await send_random_messages()
    await message.answer("✅ Повідомлення надіслано всім активним користувачам!")

# Функція для розсилки випадкових повідомлень
async def send_random_messages():
    messages = [
        "Ти чудовий!", "Не забувай посміхатися!", "В тебе все вийде!", "Ти особливий!",
        "Новий день – нові можливості! Лови їх!", "Ти сильніший, ніж думаєш. Усе вийде!",
        "Сьогодні твій день – зроби його крутим!", "Прокидайся! У світу для тебе є щось особливе!",
        "Сонце вже світить для тебе – час підкорювати світ!", "Зроби сьогодні те, про що завтра подякуєш собі!",
        "Твоя енергія – твоя суперсила! Використай її!", "Кожен новий ранок – це шанс почати спочатку!",
        "Не бійся труднощів – вони роблять тебе сильнішим!", "Сьогодні ти на крок ближче до своєї мрії!",
        "Дихай глибше, усміхайся ширше – вперед до успіху!", "Світ чекає на твої звершення!",
        "Будь собою – це вже твоя суперсила!", "Кава, заряд позитиву і вперед до перемог!",
        "Щасливий день починається з усмішки!", "Не відкладай щастя – створюй його вже сьогодні!",
        "Роби те, що приносить тобі радість!", "Твої старання обов’язково принесуть плоди!",
        "Маленькі кроки ведуть до великих перемог!", "Зараз – найкращий час, щоб почати діяти!",
        "Навіть найтемніший ранок може стати яскравим!", "Відпусти сумніви – вперед до звершень!",
        "Живи цей день так, щоб увечері сказати: “Я молодець!”", "Ти заслуговуєш на щасливе і насичене життя!",
        "Дивись на світ з оптимізмом – він відповість тобі тим самим!", "Кожна твоя дія – це крок до успіху!",
        "Розправ крила і лети до своєї мрії!", "Ти можеш досягти всього, що задумано!", "Новий день – нові можливості. Вперед!",
        "Сила всередині тебе, використовуй її!",
        "Всі двері відкриваються для тих, хто стукає!",
        "Кожен день – це шанс стати кращим!",
        "Навіть маленький крок веде до великого успіху!",
        "Сьогодні – ідеальний день для нових звершень!",
        "Життя – це пригода, насолоджуйся кожною миттю!",
        "Кожен виклик – це можливість вирости!",
        "Не бійся змін, вони ведуть до кращого!",
        "Сміливість – це ключ до будь-яких досягнень!",
        "Віра в себе – це перший крок до успіху!",
        "Твої ідеї та мрії варті реалізації!",
        "Труднощі роблять нас сильнішими!",
        "Щоранку прокидайся з натхненням!",
        "Не зупиняйся на півдорозі до мрії!",
        "Життя – це не очікування, а дія!",
        "Сьогодні ідеальний день для гарних новин!",
        "Світ повний можливостей – використай їх!",
        "Успіх – це результат щоденних зусиль!",
        "Ніхто не знає, що ти можеш, крім тебе самого!",
        "Завжди є привід для радості, знайди його!",
        "Позитивний настрій притягує хороші події!",
        "Що б не сталося – все на краще!",
        "Завжди рухайся вперед, навіть якщо повільно!",
        "Кожен день – це новий старт!",
        "Важливо не скільки разів ти падаєш, а скільки піднімаєшся!",
        "Будь-яка справа починається з першого кроку!",
        "Світ відкритий для тих, хто готовий діяти!",
        "Тільки вперед – успіх вже чекає!",
        "Перемога починається з віри в себе!",
        "Твої можливості безмежні!",
        "Кожен день – це подарунок, використай його!",
        "Навіть маленькі зусилля ведуть до великих змін!",
        "Посміхнись, і світ відповість тим самим!",
        "Дорога до успіху починається сьогодні!",
        "Не дозволяй сумнівам завадити руху вперед!",
        "Живи так, щоб кожен день був особливим!",
        "Не чекай ідеального моменту – твори його!",
        "Кожна помилка – це крок до мудрості!",
        "Роби те, що наповнює тебе енергією!",
        "Пам’ятай: ти сильніший, ніж здається!",
        "Головне – почати, а далі буде легше!",
        "Щасливий день починається з гарного настрою!",
        "Навколо тебе більше добра, ніж здається!",
        "Роби своє, і результат не змусить чекати!",
        "Почни день з усмішки – і все складеться!",
        "Не сумнівайся в собі, ти на правильному шляху!",
        "Кожен день – це можливість створити щось прекрасне!",
        "Світ чекає на твої великі звершення!"
        "Ти неймовірний!", "Вір у себе – ти здатний на більше!", "Ти здолаєш будь-які труднощі!",
        "Ніколи не здавайся!", "Кожен день – це новий шанс!", "У тебе є все, щоб досягти мети!",
        "Продовжуй рухатися вперед, ти на правильному шляху!", "Твоя рішучість – твій ключ до успіху!",
        "Життя дарує тобі безліч можливостей, скористайся ними!", "Не бійтеся мріяти – мрії здійснюються!",
        "Ти сильний, навіть коли не відчуваєш це!", "Ти здатний подолати будь-які перешкоди!",
        "У тебе є все, щоб досягти великих висот!", "Вір у свої сили, і все буде добре!",
        "Завжди пам'ятай, що ти вартий більше!", "Продовжуй розвиватися – кожен крок вперед важливий!",
        "Ти вже на шляху до великої мети!", "Немає нічого неможливого для того, хто вірить!",
        "Кожен день – це шанс стати кращим!", "Твоя стійкість захоплює!",
        "У тебе є все, щоб змінити своє життя на краще!", "Сьогоднішній день – це новий початок!",
        "Ти не один – ми всі тут, щоб підтримати тебе!", "Не бійтеся бути іншими, ви вже унікальні!",
        "Всі великі досягнення починаються з маленьких кроків!", "Ти – приклад для наслідування!",
        "Ваша рішучість і сила волі неймовірні!", "Пам’ятай, що ти – невід’ємна частина цього світу!",
        "Ти вже зробив перший крок, тепер іди далі!", "Підкорюй свої мрії та амбіції!",
        "Сміливо йди вперед, світ чекає на тебе!", "Ти все здолаєш!",
        "У тебе є сила зробити цей день особливим!", "Що б не сталося, пам’ятай: ти завжди маєш можливість змінити ситуацію!",
        "Твоя енергія не має меж!", "Завжди пам’ятай про свою цінність!",
        "Ти маєш силу змінювати світ на краще!", "Ти справжній герой у власній історії!",
        "Сьогодні буде ще один чудовий день!", "Твоя рішучість допоможе тобі подолати будь-які труднощі!",
        "Ти маєш внутрішню силу, яка допоможе подолати все!", "Ти заслуговуєш на всі найкращі речі в житті!",
        "Ти – натхнення для багатьох!", "Не бійтеся змін, вони приводять до великого!",
        "Ваша ціль зовсім близько, тримайся!", "Ти сильніший, ніж ти думаєш!",
        "Будь впевнений у собі – ти справжній лідер!", "У тебе є все для того, щоб створити своє щастя!",
        "Ти – унікальний, не забувай про це!", "Життя не має меж, і твої можливості – теж!",
        "Сьогодні саме той день, щоб розпочати новий шлях!", "Ти – чудовий, продовжуй працювати над собою!",
        "Вір у себе, і ти побачиш чудеса!", "Твоя праця обов'язково принесе плоди!",
        "Не забувай, що ти сильніший за будь-які обставини!", "Ваша енергія може змінити цей світ!",
        "Ти вже на півшляху до своєї мети!", "У тебе є все для того, щоб бути щасливим!",
        "Ти народжений для великих справ!", "Кожен крок наближає тебе до мрії!",
        "Твоя рішучість і віра в себе безцінні!", "Ти справжній боєць – продовжуй боротися!",
        "Всі великі досягнення починаються з маленьких кроків!", "Ти здатний на більше, ніж ти думаєш!",
        "Не бійтеся труднощів – вони роблять вас сильнішими!", "Не забувай, що ти здатний змінити світ!",
        "Ти вже зробив найважчий крок – дій!", "Ти можеш зробити все, що забажаєш!",
        "Твоя віра в себе – це твоя сила!", "Будь відважним, мрії здійснюються!",
        "Ти здатний досягти будь-якої вершини!", "Не дозволяй сумнівам зупиняти тебе!",
        "Кожен день – це шанс стати кращим!", "Ти володієш безмежною енергією!",
        "У тебе є все для того, щоб здійснити свої мрії!", "Ти здатний підкорити будь-які вершини!",
        "Твоя рішучість допоможе тобі подолати всі труднощі!", "Ти готовий до нових звершень!",
        "Ти чудовий, і це не можна заперечити!", "Вір у себе і не бійтеся помилок!",
        "Ти – джерело позитиву для навколишніх!", "Справжня сила в твоїх руках!",
        "Пам’ятай, що немає нічого неможливого!", "Ти заслуговуєш на найкраще!",
        "Твій шлях – це шлях перемоги!", "Будь сміливим, ти здатний на великі справи!",
        "Ти вже близько до своєї мети – продовжуй йти!", "Не бійтеся виглядати іншими – це ваш стиль!",
        "Кожен день приносить нові можливості!", "Ти – переможець у будь-якій ситуації!",
        "Твоя енергія – це твоє величезне багатство!", "Ти здатний змінити своє життя!",
        "Вір у себе, і весь світ відкриється для тебе!", "Ти – справжній майстер своєї долі!",
        "Рухайся вперед, ти вже зробив перший крок!", "Ти готовий до великих досягнень!",
        "Ти здатний бути кращим версією себе!", "Ти маєш неймовірний потенціал!",
        "Твоя рішучість вражає!", "Ти надихаєш інших своєю силою волі!"
    ]
    users = await get_users()
    for user_id in users:
        try:
            await bot.send_message(user_id, random.choice(messages))
        except Exception as e:
            logging.warning(f"Не вдалося надіслати повідомлення {user_id}: {e}")

# Планувальник для щоденних повідомлень
scheduler = AsyncIOScheduler()
scheduler.add_job(send_random_messages, CronTrigger(hour=10, minute=0, timezone=kyiv_tz))
scheduler.add_job(send_random_messages, CronTrigger(hour=18, minute=0, timezone=kyiv_tz))

# Основна функція запуску бота
async def main():
    await init_db()  # Ініціалізація бази
    scheduler.start()  # Запуск планувальника
    await dp.start_polling(bot)  # Запуск бота

if __name__ == "__main__":
    asyncio.run(main())
