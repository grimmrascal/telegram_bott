import asyncio
import logging
import random
import os
import asyncpg
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger
from pytz import timezone
from dotenv import load_dotenv

# Завантаження змінних середовища
load_dotenv()
TOKEN = os.getenv("BOT_TOKEN")
DATABASE_URL = os.getenv("DATABASE_URL")

if not TOKEN or not DATABASE_URL:
    raise ValueError("❌ Токен або URL бази даних не знайдено! Перевірте файл .env.")

# Налаштування логування
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")

# Ініціалізація бота і диспетчера
bot = Bot(token=TOKEN)
dp = Dispatcher()

# Часовий пояс Києва
kyiv_tz = timezone("Europe/Kyiv")

# Підключення до бази даних
async def init_db():
    conn = await asyncpg.connect(DATABASE_URL)
    await conn.execute("""
        CREATE TABLE IF NOT EXISTS users (
            user_id BIGINT PRIMARY KEY
        )
    """)
    await conn.close()

# Додавання користувача в базу
async def add_user(user_id):
    conn = await asyncpg.connect(DATABASE_URL)
    await conn.execute("INSERT INTO users (user_id) VALUES ($1) ON CONFLICT DO NOTHING", user_id)
    await conn.close()

# Видалення користувача з бази
async def remove_user(user_id):
    conn = await asyncpg.connect(DATABASE_URL)
    await conn.execute("DELETE FROM users WHERE user_id = $1", user_id)
    await conn.close()

# Отримання всіх користувачів з бази
async def get_all_users():
    conn = await asyncpg.connect(DATABASE_URL)
    users = await conn.fetch("SELECT user_id FROM users")
    await conn.close()
    return [user["user_id"] for user in users]

# Обробник команди /start
@dp.message(Command("start"))
async def start_handler(message: types.Message):
    user_id = message.from_user.id
    await add_user(user_id)
    await message.answer(f"Привіт, {message.from_user.first_name}! Ти додана у список розсилки.")
    logging.info(f"✅ Користувач {user_id} доданий у базу.")

# Обробник команди /sendnow для миттєвої розсилки
@dp.message(Command("sendnow"))
async def send_now_handler(message: types.Message):
    await send_random_messages()
    # await message.answer("✅ Повідомлення надіслано всім активним користувачам!")

# Функція для розсилки випадкових приємних повідомлень
async def send_random_messages():
    messages = [
        "Ти чудовий!", "Не забувай посміхатися!", "В тебе все вийде!", "Ти особливий!", "Ти чудовий!", "Не забувай посміхатися!", "В тебе все вийде!", "Ти особливий!",
        "Новий день – нові можливості! Лови їх!", "Ти сильніший, ніж думаєш. Усе вийде!",
        "Сьогодні твій день – зроби його крутим!", "Прокидайся! У світу для тебе є щось особливе!",
        "Сонце вже світить для тебе – час підкорювати світ!", "Зроби сьогодні те, про що завтра подякуєш собі!",
        "Твоя енергія – твоя суперсила! Використай її!", "Кожен новий ранок – це шанс почати спочатку!",
        "Не бійся труднощів – вони роблять тебе сильнішим!", "Сьогодні ти на крок ближче до своєї мрії!",
        "Дихай глибше, усміхайся ширше – вперед до успіху!", "Світ чекає на твої звершення!",
        "Будь собою – це вже твоя суперсила!", "Кава, заряд позитиву і вперед до перемог!",
        "Щасливий день починається з усмішки!", "Не відкладай щастя – створюй його вже сьогодні!",
        "Роби те, що приносить тобі радість!", "Твої старання обов’язково принесуть плоди!",
        "Маленькі кроки ведуть до великих перемог!", "Зараз – найкращий час, щоб почати діяти!",
        "Навіть найтемніший ранок може стати яскравим!", "Відпусти сумніви – вперед до звершень!",
        "Живи цей день так, щоб увечері сказати: “Я молодець!”", "Ти заслуговуєш на щасливе і насичене життя!",
        "Дивись на світ з оптимізмом – він відповість тобі тим самим!", "Кожна твоя дія – це крок до успіху!",
        "Розправ крила і лети до своєї мрії!", "Ти можеш досягти всього, що задумано!", "Новий день – нові можливості. Вперед!",      "Ти неймовірний!", "Вір у себе – ти здатний на більше!", "Ти здолаєш будь-які труднощі!",
        "Ніколи не здавайся!", "Кожен день – це новий шанс!", "У тебе є все, щоб досягти мети!",
        "Продовжуй рухатися вперед, ти на правильному шляху!", "Твоя рішучість – твій ключ до успіху!",
        "Життя дарує тобі безліч можливостей, скористайся ними!", "Не бійтеся мріяти – мрії здійснюються!",
        "Ти сильний, навіть коли не відчуваєш це!", "Ти здатний подолати будь-які перешкоди!",
        "У тебе є все, щоб досягти великих висот!", "Вір у свої сили, і все буде добре!",
        "Завжди пам'ятай, що ти вартий більше!", "Продовжуй розвиватися – кожен крок вперед важливий!",
        "Ти вже на шляху до великої мети!", "Немає нічого неможливого для того, хто вірить!",
        "Кожен день – це шанс стати кращим!", "Твоя стійкість захоплює!",
        "У тебе є все, щоб змінити своє життя на краще!", "Сьогоднішній день – це новий початок!",
        "Ти не один – ми всі тут, щоб підтримати тебе!", "Не бійтеся бути іншими, ви вже унікальні!",
        "Всі великі досягнення починаються з маленьких кроків!", "Ти – приклад для наслідування!",
        "Ваша рішучість і сила волі неймовірні!", "Пам’ятай, що ти – невід’ємна частина цього світу!",
        "Ти вже зробив перший крок, тепер іди далі!", "Підкорюй свої мрії та амбіції!",
        "Сміливо йди вперед, світ чекає на тебе!", "Ти все здолаєш!",
        "У тебе є сила зробити цей день особливим!", "Що б не сталося, пам’ятай: ти завжди маєш можливість змінити ситуацію!",
        "Твоя енергія не має меж!", "Завжди пам’ятай про свою цінність!",
        "Ти маєш силу змінювати світ на краще!", "Ти справжній герой у власній історії!",
        "Сьогодні буде ще один чудовий день!", "Твоя рішучість допоможе тобі подолати будь-які труднощі!",
        "Ти маєш внутрішню силу, яка допоможе подолати все!", "Ти заслуговуєш на всі найкращі речі в житті!",
        "Ти – натхнення для багатьох!", "Не бійтеся змін, вони приводять до великого!",
        "Ваша ціль зовсім близько, тримайся!", "Ти сильніший, ніж ти думаєш!",
        "Будь впевнений у собі – ти справжній лідер!", "У тебе є все для того, щоб створити своє щастя!",
        "Ти – унікальний, не забувай про це!", "Життя не має меж, і твої можливості – теж!",
        "Сьогодні саме той день, щоб розпочати новий шлях!", "Ти – чудовий, продовжуй працювати над собою!",
        "Вір у себе, і ти побачиш чудеса!", "Твоя праця обов'язково принесе плоди!",
        "Не забувай, що ти сильніший за будь-які обставини!", "Ваша енергія може змінити цей світ!",
        "Ти вже на півшляху до своєї мети!", "У тебе є все для того, щоб бути щасливим!",
        "Ти народжений для великих справ!", "Кожен крок наближає тебе до мрії!",
        "Твоя рішучість і віра в себе безцінні!", "Ти справжній боєць – продовжуй боротися!",
        "Всі великі досягнення починаються з маленьких кроків!", "Ти здатний на більше, ніж ти думаєш!",
        "Не бійтеся труднощів – вони роблять вас сильнішими!", "Не забувай, що ти здатний змінити світ!",
        "Ти вже зробив найважчий крок – дій!", "Ти можеш зробити все, що забажаєш!",
        "Твоя віра в себе – це твоя сила!", "Будь відважним, мрії здійснюються!",
        "Ти здатний досягти будь-якої вершини!", "Не дозволяй сумнівам зупиняти тебе!",
        "Кожен день – це шанс стати кращим!", "Ти володієш безмежною енергією!",
        "У тебе є все для того, щоб здійснити свої мрії!", "Ти здатний підкорити будь-які вершини!",
        "Твоя рішучість допоможе тобі подолати всі труднощі!", "Ти готовий до нових звершень!",
        "Ти чудовий, і це не можна заперечити!", "Вір у себе і не бійтеся помилок!",
        "Ти – джерело позитиву для навколишніх!", "Справжня сила в твоїх руках!",
        "Пам’ятай, що немає нічого неможливого!", "Ти заслуговуєш на найкраще!",
        "Твій шлях – це шлях перемоги!", "Будь сміливим, ти здатний на великі справи!",
        "Ти вже близько до своєї мети – продовжуй йти!", "Не бійтеся виглядати іншими – це ваш стиль!",
        "Кожен день приносить нові можливості!", "Ти – переможець у будь-якій ситуації!",
        "Твоя енергія – це твоє величезне багатство!", "Ти здатний змінити своє життя!",
        "Вір у себе, і весь світ відкриється для тебе!", "Ти – справжній майстер своєї долі!",
        "Рухайся вперед, ти вже зробив перший крок!", "Ти готовий до великих досягнень!",
        "Ти здатний бути кращим версією себе!", "Ти маєш неймовірний потенціал!",
        "Твоя рішучість вражає!", "Ти надихаєш інших своєю силою волі!"
    ]
    users = await get_all_users()
    for user_id in users:
        try:
            await bot.send_message(user_id, random.choice(messages))
            logging.info(f"📨 Повідомлення надіслано {user_id}")
        except Exception as e:
            logging.warning(f"⚠️ Не вдалося надіслати {user_id}: {e}")

# Логування всіх оновлень (для діагностики)
@dp.update()
async def all_updates_handler(update: types.Update):
    logging.info(f"📥 Отримано оновлення: {update}")

# Обробник виходу користувача з чату
@dp.chat_member()
async def chat_member_handler(update: types.ChatMemberUpdated):
    user_id = update.from_user.id
    new_status = update.new_chat_member.status

    if new_status in ["kicked", "left"]:
        await remove_user(user_id)
        logging.info(f"❌ Користувач {user_id} видалений з бази.")

# Планувальник для щоденних повідомлень (2 рази на день)
scheduler = AsyncIOScheduler()
scheduler.add_job(send_random_messages, CronTrigger(hour=10, minute=0, timezone=kyiv_tz))  # 10:00
scheduler.add_job(send_random_messages, CronTrigger(hour=18, minute=0, timezone=kyiv_tz))  # 18:00

# Основна функція запуску бота
async def main():
    await init_db()  # Ініціалізуємо БД
    scheduler.start()  # Запускаємо планувальник
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())