import asyncio
import logging
import random
import os
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import FSInputFile
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from pytz import timezone
import aiohttp
import asyncpg
from dotenv import load_dotenv

load_dotenv()

# Налаштування
TOKEN = os.getenv("BOT_TOKEN")
DATABASE_URL = os.getenv("DATABASE_URL")
PIXABAY_API_KEY = os.getenv("PIXABAY_API_KEY")

bot = Bot(token=TOKEN)
dp = Dispatcher()
scheduler = AsyncIOScheduler()

# Часовий пояс
kyiv_tz = timezone("Europe/Kyiv")

# Підключення до бази даних
async def init_db():
    global pool
    pool = await asyncpg.create_pool(DATABASE_URL)

async def close_db():
    await pool.close()

# Ініціалізація БД
async def setup_db():
    async with pool.acquire() as conn:
        await conn.execute(
            """CREATE TABLE IF NOT EXISTS users (
                id SERIAL PRIMARY KEY,
                user_id BIGINT UNIQUE
            )"""
        )

# Додавання користувача
async def add_user(user_id):
    async with pool.acquire() as conn:
        await conn.execute("INSERT INTO users (user_id) VALUES ($1) ON CONFLICT DO NOTHING", user_id)

# Отримання списку користувачів
async def get_users():
    async with pool.acquire() as conn:
        rows = await conn.fetch("SELECT user_id FROM users")
        return [row["user_id"] for row in rows]
        
TOPICS = ["cute", "animals", "nature", "flowers", "sunset"]
# Отримання випадкового фото з Pixabay за заданою темою
async def get_random_photo():
    url = f"https://pixabay.com/api/?key={PIXABAY_API_KEY}&q={topic}&image_type=photo&per_page=50"
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as response:
            data = await response.json()
            if "hits" in data and len(data["hits"]) > 0:
                return random.choice(data["hits"])["webformatURL"]
            return None

# Випадкові повідомлення
messages = [
        "Ти чудовий!", "Не забувай посміхатися!", "В тебе все вийде!", "Ти особливий!", "Ти чудовий!", "Не забувай посміхатися!", "В тебе все вийде!", "Ти особливий!",
        "Новий день – нові можливості! Лови їх!", "Ти сильніший, ніж думаєш. Усе вийде!",
        "Сьогодні твій день – зроби його крутим!", "Прокидайся! У світу для тебе є щось особливе!",
        "Сонце вже світить для тебе – час підкорювати світ!", "Зроби сьогодні те, про що завтра подякуєш собі!",
        "Твоя енергія – твоя суперсила! Використай її!", "Кожен новий ранок – це шанс почати спочатку!",
        "Не бійся труднощів – вони роблять тебе сильнішим!", "Сьогодні ти на крок ближче до своєї мрії!",
        "Дихай глибше, усміхайся ширше – вперед до успіху!", "Світ чекає на твої звершення!",
        "Будь собою – це вже твоя суперсила!", "Кава, заряд позитиву і вперед до перемог!",
        "Щасливий день починається з усмішки!", "Не відкладай щастя – створюй його вже сьогодні!",
        "Роби те, що приносить тобі радість!", "Твої старання обов’язково принесуть плоди!",
        "Маленькі кроки ведуть до великих перемог!", "Зараз – найкращий час, щоб почати діяти!",
        "Навіть найтемніший ранок може стати яскравим!", "Відпусти сумніви – вперед до звершень!",
        "Живи цей день так, щоб увечері сказати: “Я молодець!”", "Ти заслуговуєш на щасливе і насичене життя!",
        "Дивись на світ з оптимізмом – він відповість тобі тим самим!", "Кожна твоя дія – це крок до успіху!",
        "Розправ крила і лети до своєї мрії!", "Ти можеш досягти всього, що задумано!", "Новий день – нові можливості. Вперед!",      "Ти неймовірний!", "Вір у себе – ти здатний на більше!", "Ти здолаєш будь-які труднощі!",
        "Ніколи не здавайся!", "Кожен день – це новий шанс!", "У тебе є все, щоб досягти мети!",
        "Продовжуй рухатися вперед, ти на правильному шляху!", "Твоя рішучість – твій ключ до успіху!",
        "Життя дарує тобі безліч можливостей, скористайся ними!", "Не бійтеся мріяти – мрії здійснюються!",
        "Ти сильний, навіть коли не відчуваєш це!", "Ти здатний подолати будь-які перешкоди!",
        "У тебе є все, щоб досягти великих висот!", "Вір у свої сили, і все буде добре!",
        "Завжди пам'ятай, що ти вартий більше!", "Продовжуй розвиватися – кожен крок вперед важливий!",
        "Ти вже на шляху до великої мети!", "Немає нічого неможливого для того, хто вірить!",
        "Кожен день – це шанс стати кращим!", "Твоя стійкість захоплює!",
        "У тебе є все, щоб змінити своє життя на краще!", "Сьогоднішній день – це новий початок!",
        "Ти не один – ми всі тут, щоб підтримати тебе!", "Не бійтеся бути іншими, ви вже унікальні!",
        "Всі великі досягнення починаються з маленьких кроків!", "Ти – приклад для наслідування!",
        "Ваша рішучість і сила волі неймовірні!", "Пам’ятай, що ти – невід’ємна частина цього світу!",
        "Ти вже зробив перший крок, тепер іди далі!", "Підкорюй свої мрії та амбіції!",
        "Сміливо йди вперед, світ чекає на тебе!", "Ти все здолаєш!",
        "У тебе є сила зробити цей день особливим!", "Що б не сталося, пам’ятай: ти завжди маєш можливість змінити ситуацію!",
        "Твоя енергія не має меж!", "Завжди пам’ятай про свою цінність!",
        "Ти маєш силу змінювати світ на краще!", "Ти справжній герой у власній історії!",
        "Сьогодні буде ще один чудовий день!", "Твоя рішучість допоможе тобі подолати будь-які труднощі!",
        "Ти маєш внутрішню силу, яка допоможе подолати все!", "Ти заслуговуєш на всі найкращі речі в житті!",
        "Ти – натхнення для багатьох!", "Не бійтеся змін, вони приводять до великого!",
        "Ваша ціль зовсім близько, тримайся!", "Ти сильніший, ніж ти думаєш!",
        "Будь впевнений у собі – ти справжній лідер!", "У тебе є все для того, щоб створити своє щастя!",
        "Ти – унікальний, не забувай про це!", "Життя не має меж, і твої можливості – теж!",
        "Сьогодні саме той день, щоб розпочати новий шлях!", "Ти – чудовий, продовжуй працювати над собою!",
        "Вір у себе, і ти побачиш чудеса!", "Твоя праця обов'язково принесе плоди!",
        "Не забувай, що ти сильніший за будь-які обставини!", "Ваша енергія може змінити цей світ!",
        "Ти вже на півшляху до своєї мети!", "У тебе є все для того, щоб бути щасливим!",
        "Ти народжений для великих справ!", "Кожен крок наближає тебе до мрії!",
        "Твоя рішучість і віра в себе безцінні!", "Ти справжній боєць – продовжуй боротися!",
        "Всі великі досягнення починаються з маленьких кроків!", "Ти здатний на більше, ніж ти думаєш!",
        "Не бійтеся труднощів – вони роблять вас сильнішими!", "Не забувай, що ти здатний змінити світ!",
        "Ти вже зробив найважчий крок – дій!", "Ти можеш зробити все, що забажаєш!",
        "Твоя віра в себе – це твоя сила!", "Будь відважним, мрії здійснюються!",
        "Ти здатний досягти будь-якої вершини!", "Не дозволяй сумнівам зупиняти тебе!",
        "Кожен день – це шанс стати кращим!", "Ти володієш безмежною енергією!",
        "У тебе є все для того, щоб здійснити свої мрії!", "Ти здатний підкорити будь-які вершини!",
        "Твоя рішучість допоможе тобі подолати всі труднощі!", "Ти готовий до нових звершень!",
        "Ти чудовий, і це не можна заперечити!", "Вір у себе і не бійтеся помилок!",
        "Ти – джерело позитиву для навколишніх!", "Справжня сила в твоїх руках!",
        "Пам’ятай, що немає нічого неможливого!", "Ти заслуговуєш на найкраще!",
        "Твій шлях – це шлях перемоги!", "Будь сміливим, ти здатний на великі справи!",
        "Ти вже близько до своєї мети – продовжуй йти!", "Не бійтеся виглядати іншими – це ваш стиль!",
        "Кожен день приносить нові можливості!", "Ти – переможець у будь-якій ситуації!",
        "Твоя енергія – це твоє величезне багатство!", "Ти здатний змінити своє життя!",
        "Вір у себе, і весь світ відкриється для тебе!", "Ти – справжній майстер своєї долі!",
        "Рухайся вперед, ти вже зробив перший крок!", "Ти готовий до великих досягнень!",
        "Ти здатний бути кращим версією себе!", "Ти маєш неймовірний потенціал!",
        "Твоя рішучість вражає!", "Ти надихаєш інших своєю силою волі!"
]

# Відправка запланованих повідомлень
async def send_random_messages(topic="cute"):
    users = await get_users()
    text = random.choice(messages)
    photo_url = await get_random_photo(topic)
    
    for user_id in users:
        try:
            if photo_url:
                await bot.send_photo(chat_id=user_id, photo=photo_url, caption=text)
            else:
                await bot.send_message(chat_id=user_id, text=text)
        except Exception as e:
            logging.error(f"Помилка надсилання {user_id}: {e}")

# Команда старт
@dp.message(Command("start"))
async def start(message: types.Message):
    await add_user(message.from_user.id)
    await message.answer("Ви підписалися на розсилку!")

# Команда для миттєвої розсилки
@dp.message(Command("sendnow"))
async def sendnow(message: types.Message):
    topic = "cute"  # За замовчуванням "cute", але можна обирати інші теми
    await send_random_messages(topic)

# Команда для вибору теми
@dp.message(Command("settheme"))
async def set_theme(message: types.Message):
    theme = message.text.split(" ", 1)[1] if len(message.text.split(" ", 1)) > 1 else ""
    
    if theme:
        await message.answer(f"Тема для фото змінена на: {theme}")
        await send_random_messages(theme)
    else:
        await message.answer("Будь ласка, вкажіть тему після команди. Наприклад: /settheme cute")

# Запуск планувальника
scheduler.add_job(send_random_messages, "cron", hour=9, minute=0, timezone=kyiv_tz)
scheduler.add_job(send_random_messages, "cron", hour=12, minute=0, timezone=kyiv_tz)
scheduler.add_job(send_random_messages, "cron", hour=18, minute=0, timezone=kyiv_tz)

async def main():
    await init_db()
    await setup_db()
    scheduler.start()
    await dp.start_polling(bot)
    await close_db()

if __name__ == "__main__":
    asyncio.run(main())